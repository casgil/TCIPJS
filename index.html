<!DOCTYPE html>
<html>
  <head>
    <title>Two Choice Impulsivity Paradigm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="./jspsych/jspsych.js"></script>
    <script src="./jspsych/plugin-html-button-response.js"></script>
    <script src="./jspsych/plugin-tcip-wait.js"></script>
    <link href="./jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /* Ensure proper styling in iframe */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow-x: hidden; /* Prevent horizontal overflow */
        }
        
        /* Make sure jsPsych content is visible */
        #jspsych-content {
            margin: 20px auto;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            padding: 0 10px;
        }
        
        /* Prevent elements from overflowing */
        * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            #jspsych-content {
                margin: 10px auto;
                padding: 0 5px;
            }
            
            /* Make all p elements with inline styles responsive */
            p[style*="width:800px"],
            p[style*="width: 800px"],
            p[style*="width:100%"] {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Scale down font sizes on mobile */
            p[style*="font-size:30px"] {
                font-size: 20px !important;
            }
            
            p[style*="font-size:25px"] {
                font-size: 16px !important;
            }
        }
        
        /* Prevent button overflow */
        .jspsych-btn {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure text wraps properly */
        p {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Container adjustments for very small screens */
        @media (max-width: 480px) {
            #jspsych-content {
                padding: 0;
            }
        }
    </style>
  </head>
  <body>
  </body>
  <script>

    // Check if we're running in an iframe (for Qualtrics integration)
    const isInIframe = window.self !== window.top;
    let qualtricsIntegration = false;

    // Listen for messages from parent window (Qualtrics)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'QUALTRICS_INTEGRATION') {
            qualtricsIntegration = event.data.enableDataCapture;
            console.log('Qualtrics integration enabled:', qualtricsIntegration);
        }
    });

    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        // Save data locally (original functionality)
        jsPsych.data.get().localSave('csv','mydata.csv');
        
        // Send data to parent window if in iframe (for Qualtrics)
        if (isInIframe && qualtricsIntegration) {
            try {
                const allData = jsPsych.data.get().values();
                window.parent.postMessage({
                    type: 'TCIP_COMPLETE',
                    data: allData,
                    timestamp: Date.now()
                }, '*');
                console.log('Data sent to parent window:', allData.length, 'trials');
            } catch (error) {
                console.error('Error sending data to parent:', error);
            }
        }
      }
    });

    var timeline = [];
    const trials = 15;
    let points = 0;
    let delay = 15000;
    let circleCount = 0;
    let progress = 0;
    let shape = '';
    let type = '';
    let outputDelay = 0;
    
    // Get responsive width based on screen size
    function getResponsiveWidth() {
        return window.innerWidth < 768 ? '100%' : '800px';
    }
    
    function getResponsivePadding() {
        return window.innerWidth < 768 ? '15px' : '30px';
    }
    
    const pointStyle = function() {
        const width = getResponsiveWidth();
        const padding = getResponsivePadding();
        return '<p style="font-size:30px;color:white;text-align:left;background-color:#393939;width:' + width + ';height:auto;padding:' + padding + ';max-width:100%;box-sizing:border-box;">Current Points: ';
    };
    const circleInline = '<button class="buttonCircle" style="height:100px;width:100px;';
    const squareInline = '<button class="buttonSquare" style="height:100px;width:100px;';
    const waitInline = function() {
        const width = getResponsiveWidth();
        const padding = getResponsivePadding();
        return '</p><br><p style="font-size:25px;text-align:center;width:' + width + ';height:auto;padding:' + padding + ';max-width:100%;box-sizing:border-box;">Please wait... Points are loading</p>';
    };
    const addInline = function() {
        const width = getResponsiveWidth();
        const padding = getResponsivePadding();
        return '</p><br><p style="font-size:25px;text-align:center;width:' + width + ';height:auto;padding:' + padding + ';max-width:100%;box-sizing:border-box;">Click the shape to collect your points!</p>';
    };
    const blockInline = function() {
        const width = getResponsiveWidth();
        const padding = getResponsivePadding();
        return '<p style="width:' + width + ';height:30px;padding:' + padding + ';max-width:100%;box-sizing:border-box;"></p>';
    };

    function getPoints() {
        if (type === 'wait') {
            return pointStyle() + points + waitInline()
        }
        else if (type === 'add') {
            return pointStyle() + points + addInline()
        }
        else {
            return pointStyle() + points +'</p>'
        }
    }
    
    function getDelay() {
        return delay
    }

    function getShape() {
        if (type === 'wait') {
            if (shape === 'Circle') {
                return circleInline + 'background-color:grey;"></button>' 
            }
            else { 
                return squareInline + 'background-color:grey;"></button>'
            }
        }
        else {
            if (shape === 'Circle') {
                return circleInline + '"></button>' 
            }
            else { 
                return squareInline + '"></button>'
            }
        }
    }

    function getPrompt() {
        if (shape === 'Circle') {
            outputDelay = delay / 1000;
            return '<p>You will receive 5 points in ' + outputDelay + ' seconds</p>'
        }
        else {
            return '<p>You will receive 15 points in 15 seconds</p>'
        }
    }

    var instructions_1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><strong>Welcome to the Decision Making Task!</strong><br><br>In this task, you will choose between two shapes: a circle and a square.<br><br>Each choice will earn you points, but you will need to wait different amounts of time to collect them.</p>',
        choices: ['NEXT', 'SKIP INSTRUCTIONS'],
    }

    var instructions_2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><strong>The Circle Choice:</strong><br><br>• First time: Wait 5 seconds → Get 5 points<br>• Second time: Wait 6 seconds → Get 5 points<br>• Third time: Wait 7 seconds → Get 5 points<br>• And so on...<br><br>The wait time gets longer each time you choose the circle, but you always get exactly 5 points.</p>',
        choices: ['NEXT'],
    }

    var instructions_3 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><strong>The Square Choice:</strong><br><br>• Every time: Wait 15 seconds → Get 15 points<br><br>The square choice is always the same: wait 15 seconds and get 15 points. The wait time never changes.</p>',
        choices: ['NEXT'],
    }

    var instructions_4 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><strong>How to Play:</strong><br><br>• You will make ' + trials + ' choices total<br>• Your points are shown in the top-left corner<br>• After choosing, you must wait for the countdown to finish<br>• Then click the shape again to collect your points<br><br><strong>Goal:</strong> Earn as many points as possible!<br><br>Think carefully about which choice gives you the best points for the time you wait.</p>',
        choices: ['START'],
    }

    // Get responsive margins
    function getHorizontalMargin() {
        return window.innerWidth < 768 ? "10px" : "100px";
    }
    
    function getVerticalMargin() {
        return window.innerWidth < 768 ? "50px" : "100px";
    }

    var choice = {
        type: jsPsychHtmlButtonResponse,
        stimulus: getPoints,
        choices: ['Circle', 'Square'],
        button_html: [circleInline + '"></button>', squareInline + '"></button>'],
        margin_horizontal: getHorizontalMargin(),
        margin_vertical: window.innerWidth < 768 ? "50px" : "200px",
        response_ends_trial: true,
        prompt: blockInline,
        data: {
            task: 'choice',
        },
        on_finish: function(data){
            type = 'wait';
            if (data.response === 0) {
                circleCount++;
                delay = (circleCount - 1) * 1000 + 5000;
                delay > 15000 ? delay = 15000 : delay = delay;
                data.delay = delay;  
                shape = 'Circle';
                data.shape = shape;
            } 
            else if (data.response === 1) {
                delay = 15000;
                data.delay = delay;
                shape = 'Square';
                data.shape = shape;
            }
        }
    }

    var wait = {
        type: jsPsychTCIPWait,
        choices: [shape],
        stimulus: getPoints,
        button_html: [getShape],
        response_ends_trial: false,
        margin_horizontal: getHorizontalMargin(),
        margin_vertical: getVerticalMargin(),
        trial_duration: getDelay,
        prompt: getPrompt,
        data: {
            task: 'wait',
        },
        on_finish: function(data){ 
            type = 'add';
        }
    }

    var add = {
        type: jsPsychHtmlButtonResponse,
        stimulus: getPoints,
        choices: [shape],
        button_html: [getShape],
        response_ends_trial: true,
        margin_horizontal: getHorizontalMargin(),
        margin_vertical: getVerticalMargin(),
        prompt: blockInline,
        data: {
            task: 'add'
        },
        on_finish: function(data){
            type = 'choice';
            if (shape === 'Circle') {
                points = points + 5;
                data.points = points;
            } 
            else if (shape === 'Square') {
                points = points + 15;
                data.points = points
            }
        }
    }

    // Add first instruction screen
    timeline.push(instructions_1);
    
    // Add conditional instructions based on first screen response
    var conditional_instructions = {
        timeline: [instructions_2, instructions_3, instructions_4],
        conditional_function: function() {
            // Check if participant chose to skip instructions (response 1 = "SKIP INSTRUCTIONS")
            var data = jsPsych.data.getLastTrialData();
            if (data.values()[0].response === 1) {
                return false; // Skip the remaining instructions
            } else {
                return true; // Continue with instructions
            }
        }
    };
    
    timeline.push(conditional_instructions);

    var block = {
        timeline: [choice, wait, add],
        repetitions: trials,
    };
    timeline.push(block);
    
    // Add a small delay to ensure everything is loaded
    setTimeout(() => {
        jsPsych.run(timeline);
    }, 100);

  </script>
</html>

